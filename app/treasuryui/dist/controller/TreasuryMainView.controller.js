sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/PDFViewer","sap/m/BusyDialog","sap/m/MessageToast","../lib/jspdf/jspdf.umd.min","../lib/dompurify/purify.min","../lib/html2canvas/html2canvas.min"],(e,t,s,o,n)=>{"use strict";return e.extend("treasuryui.controller.TreasuryMainView",{onInit(){let e=new sap.ui.model.json.JSONModel;this.getView().setModel(e,"treasuryModel")},onBeforeShow:function(){this.getView().getModel().refresh(true)},onChatCopy:function(){const e=this.byId("ChatBotResult");const t=e?.getDomRef();if(!t){sap.m.MessageToast.show("Nothing to copy");return}const s=t.innerText;if(navigator?.clipboard&&s){navigator.clipboard.writeText(s).then(()=>{sap.m.MessageToast.show("Text copied to clipboard")}).catch(e=>{console.error("Copy failed",e);sap.m.MessageToast.show("Failed to copy text.")})}},onChatExport:async function(){if(!window.jspdf||!window.html2canvas){sap.m.MessageToast.show("Required libraries not loaded.");return}const{jsPDF:e}=window.jspdf;const t=this.getView().getModel("chatModel").getProperty("/userMessage")||"";const s=this.byId("ChatBotResult")?.getDomRef();if(!s){sap.m.MessageToast.show("No content to export");return}const o=document.createElement("div");o.style.width="794px";o.style.padding="20px";o.style.background="#fff";o.style.fontFamily="Arial, sans-serif";o.style.position="absolute";o.style.top="0";o.style.left="-9999px";document.body.appendChild(o);const n=document.createElement("div");n.style.background="linear-gradient(to right, #e8f0ff, #f2f6fd)";n.style.padding="16px 24px";n.style.borderRadius="8px";n.style.marginBottom="24px";n.style.border="1px solid #cdddfb";const a=document.createElement("div");a.textContent="USER INPUT";a.style.fontSize="18px";a.style.fontWeight="bold";a.style.color="#1a73e8";a.style.marginBottom="8px";const i=document.createElement("div");i.textContent=t;i.style.fontSize="14px";i.style.color="#333";n.appendChild(a);n.appendChild(i);o.appendChild(n);const r=document.createElement("div");r.style.margin="0";r.style.width="100%";const l=Array.from(s.children);l.forEach(e=>{const t=e.cloneNode(true);t.style.maxHeight="none";t.style.overflow="visible";r.appendChild(t)});o.appendChild(r);await new Promise(e=>requestAnimationFrame(e));try{const t=await html2canvas(o,{scale:2,useCORS:true,scrollY:0,windowWidth:o.scrollWidth,windowHeight:o.scrollHeight});const s=t.toDataURL("image/png");const n=new e("p","pt","a4");const a=n.internal.pageSize.getWidth();const i=n.internal.pageSize.getHeight();const r=a;const l=t.height*a/t.width;let c=l;let d=0;n.addImage(s,"PNG",0,d,r,l);c-=i;while(c>0){d-=i;n.addPage();n.addImage(s,"PNG",0,d,r,l);c-=i}n.save("Finsight_Chat_Export.pdf");sap.m.MessageToast.show("PDF exported successfully")}catch(e){console.error("PDF export failed",e);sap.m.MessageToast.show("Failed to export PDF")}finally{document.body.removeChild(o)}},onfetchCSRF:async function(e){const t=await fetch(e,{method:"GET",headers:{"X-CSRF-Token":"Fetch"}});const s=t.headers.get("X-CSRF-Token");if(!s){throw new Error("Failed to fetch CSRF token")}return s},onSelectDocument:function(e){var t=e.getSource();var s=t.getSelectedItems();var o=s.map(function(e){return"File: "+e.getText()});o.push("Question: ");var n=o.join("\n");this.byId("chatFeedInput").setValue(n)},onUserChat:async function(){const e=this.getOwnerComponent().getModel("chatModel");const s=this.getView();const o=this.byId("chatFeedInput").getValue();var n=this.byId("multiCombo").getSelectedItems();const a=o.toLowerCase().includes("intellibase");const i=["SELECT","INSERT","UPDATE","DELETE","DROP","UNION","CREATE","TRUNCATE"];const r=a||n.length>0;const l=i.some(e=>o.toUpperCase().includes(e));const c=o.includes("File:")&&(o.includes(".pdf")||o.includes(".xlsx")||o.includes(".docx"));this.byId("buttonCopy").setVisible(true);this.byId("buttonExport").setVisible(true);if(!c&&!a){if(n.length)this.byId("multiCombo").setSelectedKeys();this.byId("chatFeedInput").setValue("");t.error("Please select a file or Ask Intellibase");return}e.setSubmit(false);e.setvisibleResult(false);if(!o||o.length<3){t.information("Minimum 3 characters required to proceed");return}if(l){t.error("The prompt contains a malicious word, please remove it and proceed");return}const d=new sap.m.BusyDialog({title:"Busy Indicator",text:"Generating response. Please standby.."});d.open();s.setBusy(true);await Promise.resolve();this.getView().byId("htmlContent").setVisible(true);this.getView().byId("pdfContainer").setVisible(false);try{const t=await this.onfetchData(o,r,a);e.setResult(t);e.setvisibleResult(true);console.log(t);return t}catch(e){console.error("Chat fetch error:",e);sap.m.MessageToast.show("Failed to get response.")}finally{d.close();s.setBusy(false)}},onfetchData:async function(e,s,o){const n=this.getBaseUrl()+"/api/chat";const a=this.getBaseUrl()+"/user-api/currentUser";var i;const r=this.fetchCsrfToken();const l=this.byId("pdfContainer");l.removeAllItems();const c=new AbortController;const d=setTimeout(()=>{c.abort()},9e4);const h=await fetch(a,{method:"GET",headers:{"X-CSRF-Token":r,"Content-Type":"application/json"}});if(!h.ok){t.error("Not a valid user");return}const u=await h.json();const p=u.name;if(!s){t.error("Please select a file or Ask Intellibase");return}if(o){this.byId("multiCombo").setSelectedKeys();i={message:"user_id:"+p+":"+e}}else{i={message:e}}try{const e=await fetch(n,{method:"POST",headers:{"X-CSRF-Token":r,"Content-Type":"application/json"},body:JSON.stringify(i),signal:c.signal});clearTimeout(d);if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const t=await e.json();const s=t.FINAL_RESULT==="string"&&/<[^>]+>/.test(t.FINAL_RESULT);var m;if(!s){m=`<p style="color:red;">${t.FINAL_RESULT}</p>`}else m=t.FINAL_RESULT;if(o){var f=m+"<div style='margin-top:1rem; font-family: monospace; white-space: pre-wrap;'>"+"<strong>SQL Query:</strong><br/>"+t.SQL_QUERY+"</div>";return f}else return m}catch(e){console.log("inside catch of askFinsight",e)}},onGenerateSummary:async function(e){var s=this.byId("multiCombo").getSelectedItems();var o=this.byId("chatFeedInput");this.byId("buttonCopy").setVisible(false);this.byId("buttonExport").setVisible(false);if(s.length>1||s.length==0){t.error("Please select a single file to Generate Summary.");return}var n=s[0].getText();o.setValue(`Research Summary: ${n}`);this.getView().byId("htmlContent").setVisible(false);this.getView().byId("pdfContainer").setVisible(true);this._callSummaryApi(n)},getBaseUrl:function(){return sap.ui.require.toUrl("treasuryui")},fetchCsrfToken:async function(){let e=this.getBaseUrl();const t=await fetch(e,{method:"HEAD",credentials:"include",headers:{"X-CSRF-Token":"Fetch"}});const s=t.headers.get("X-CSRF-Token");return s},_callSummaryApi:async function(e){const t=new o({text:"Fetching summary..."});t.open();const s=this.getOwnerComponent().getModel("chatModel");const a=this.getBaseUrl()+"/api/chat";const i=this.fetchCsrfToken();const r={message:"Research Summary: "+e};s.setSubmit(false);s.setvisibleResult(false);try{const e=await fetch(a,{method:"POST",headers:{"X-CSRF-Token":i,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!e.ok){throw new Error(`HTTP error! Status: ${e.status}`)}const t=await e.json();if(t.success&&Array.isArray(t.summary_files)){var l=this._displayPdfFiles(t.summary_files);s.setResult(l);s.setvisibleResult(true);return l}else{n.show("No summaries returned.")}}catch(e){console.log("inside catch of generate summary",e)}finally{t.close()}},_displayPdfFiles:function(e){const t=this.byId("pdfContainer");t.removeAllItems();const s=this._createPdfViewer(e[0].data,e[0].filename);t.addItem(s);return t},_createPdfViewer:function(e,t){const s=atob(e);const o=new Uint8Array(s.length);for(let e=0;e<s.length;e++){o[e]=s.charCodeAt(e)}const n=new Blob([o],{type:"application/pdf"});const a=URL.createObjectURL(n);const i=new sap.m.Button({icon:"sap-icon://download",tooltip:"Download PDF",type:"Transparent",press:function(){const e=document.createElement("a");e.href=a;e.download=t;e.click()}});return new sap.m.Panel({headerText:t,width:"100%",height:"250vh",content:[i,new sap.ui.core.HTML({content:`<iframe src="${a}" class="pdf-iframe" style="width: 100%; height: 150vh;"></iframe>`})],layoutData:new sap.m.FlexItemData({growFactor:1})})}})});
//# sourceMappingURL=TreasuryMainView.controller.js.map